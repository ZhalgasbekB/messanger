{{template "base" .}}

<section>
  <input id="conID" value="{{.ConversationID}}" style="display: none;"/>
  <input id="recID" value="{{.UserID2}}" style="display: none;"/>
  <h2>Conversation with {{.UserID2}}</h2>
  <div class="chat-window" id="chat-window">
    {{range .Messages}}
    <div class="message">
      <strong>{{.UserIDSender}}:</strong> {{.Message}} <span class="time-post">{{.CreatedAt}}</span>
    </div>
    {{end}}
  </div>
  <form id="send-message-form">
    <textarea id="message-input" name="message" placeholder="Type your message here..." required></textarea>
    <input type="submit" value="Send">
  </form>
</section>


<script>
  document.addEventListener("DOMContentLoaded", function() {
    const ws = new WebSocket(`ws://localhost:8080/ws/chat`);
    console.log(ws)

    const chatWindow = document.getElementById('chat-window');
    const messageForm = document.getElementById('send-message-form');
    const messageInput = document.getElementById('message-input');
    
    let conversationID = parseInt(document.getElementById("conID").value, 10);
    let recipientID =  parseInt(document.getElementById("recID").value, 10);

    ws.onopen = () => {
      console.log('WebSocket connection established');
      ws.send(JSON.stringify({
        event: 'initiateConversation',
        data: {
          conversationID: conversationID, // Ensure this variable is set in your template
          recipientID: recipientID
        }
      })) 
    };
    


    ws.onmessage = (event) => {
      const message = JSON.parse(event.data);
      if (message.event === 'conversationInitiated') {
          console.log('Conversation initiated with ID:', message.data.conversationID);
          conversationID = message.data.conversationID; 
          console.log(conversationID)
      } else if (message.event === 'newMessage') {
          console.log(message)
          displayMessage(message.data.sender_id, message.data.content, message.data.created_at);
      }
    };

    ws.onerror = (error) => {
       console.error('WebSocket error:', error);
    };

    ws.onclose = (event) => {
      if (event.code === 1001) {
        console.log('WebSocket connection closed: Going away (Code 1001)');
      } else {
        console.error('WebSocket connection closed unexpectedly:', event);
      }
    };

    messageForm.addEventListener('submit', function(e) {
      e.preventDefault();

      const messageContent = messageInput.value.trim();
      if (messageContent) {
        const messageData = {
          event: 'sendMessage',
          data: {
            conversationID: conversationID, // Ensure this variable is set in your template
            content: messageContent
          }
        };
        ws.send(JSON.stringify(messageData));
        messageInput.value = ''; // Clear the input
      }
    });

    // Function to display messages in the chat window
    function displayMessage(userIDSender, message, createdAt) {
      const messageElement = document.createElement('div');
      messageElement.className = 'message';
      messageElement.innerHTML = `<strong>${userIDSender}:</strong> ${message} <span class="time-post">${createdAt}</span>`;
      chatWindow.appendChild(messageElement);
      chatWindow.scrollTop = chatWindow.scrollHeight; // Auto-scroll to the bottom
    }
  });
</script>

{{template "footer" .}}