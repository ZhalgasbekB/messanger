{{template "base" .}}

<section>
  <input id="conID" value="{{.ConversationID}}" style="display: none;"/>
  <h2>Conversation with {{.UserID2}}</h2>
  <div class="chat-window" id="chat-window">
    {{range .Messages}}
    <div class="message">
      <strong>{{.UserIDSender}}:</strong> {{.Message}} <span class="time-post">{{.CreatedAt}}</span>
    </div>
    {{end}}
  </div>
  <form id="send-message-form">
    <textarea id="message-input" name="message" placeholder="Type your message here..." required></textarea>
    <input type="submit" value="Send">
  </form>
</section>


<script>
  document.addEventListener("DOMContentLoaded", function() {
    const ws = new WebSocket(`ws://localhost:8080/ws/chat`);
    console.log(ws)

    const chatWindow = document.getElementById('chat-window');
    const messageForm = document.getElementById('send-message-form');
    const messageInput = document.getElementById('message-input');
    
    const conversationID = document.getElementById("conID").value;   

    ws.onopen = () => {
      console.log('WebSocket connection established');
      ws.send(JSON.stringify({
        event: 'joinConversation',
        data: {
          conversationID: conversationID // Ensure this variable is set in your template
        }
      }));
    };

    // Handle incoming messages
    ws.onmessage = (event) => {
    const message = JSON.parse(event.data);

    if (message.event === 'conversationInitiated') {
      // Handle the conversation initiated event
      console.log('Conversation initiated with ID:', message.data.ConversationID);
      conversationID = message.data.ConversationID; // Update conversation ID if necessary
    } else if (message.event === 'newMessage') {
      // Handle incoming messages
      displayMessage(message.data.SenderID, message.data.Content, message.data.CreatedAt);
    }
  };
    // Handle WebSocket errors
    ws.onerror = (error) => {
      console.error('WebSocket error:', error);
    };

    // Handle WebSocket closure
    ws.onclose = () => {
      console.log('WebSocket connection closed');
    };

    // Handle form submission for sending a message
    messageForm.addEventListener('submit', function(e) {
      e.preventDefault();

      const messageContent = messageInput.value.trim();
      if (messageContent) {
        const messageData = {
          event: 'sendMessage',
          data: {
            conversationID: conversationID, // Ensure this variable is set in your template
            message: messageContent
          }
        };
        ws.send(JSON.stringify(messageData));
        messageInput.value = ''; // Clear the input
      }
    });

    // Function to display messages in the chat window
    function displayMessage(userIDSender, message, createdAt) {
      const messageElement = document.createElement('div');
      messageElement.className = 'message';
      messageElement.innerHTML = `<strong>${userIDSender}:</strong> ${message} <span class="time-post">${createdAt}</span>`;
      chatWindow.appendChild(messageElement);
      chatWindow.scrollTop = chatWindow.scrollHeight; // Auto-scroll to the bottom
    }
  });
</script>

{{template "footer" .}}
